package com.Gestify.Backend.controller;

import com.Gestify.Backend.entities.ConfiguracionNegocio;
import com.Gestify.Backend.services.ConfiguracionNegocioService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.security.core.Authentication;
import org.springframework.web.bind.annotation.*;

import java.util.HashMap;
import java.util.Map;

@RestController
@RequestMapping("/api/configuracion")
@CrossOrigin(origins = {"http://localhost:5173", "https://gestifystc.vercel.app"})
public class ConfiguracionController {

    @Autowired
    private ConfiguracionNegocioService configuracionService;

    /**
     * GET /api/configuracion - Obtener configuraci√≥n del usuario autenticado
     */
    @GetMapping
    public ResponseEntity<?> obtenerConfiguracion(Authentication authentication) {
        try {
            if (authentication == null || authentication.getName() == null) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED)
                        .body(createErrorResponse("Usuario no autenticado"));
            }

            String email = authentication.getName();
            System.out.println("üì• Obteniendo configuraci√≥n para: " + email);
            
            ConfiguracionNegocio config = configuracionService.obtenerConfiguracion(email);
            System.out.println("‚úÖ Configuraci√≥n obtenida: " + config.getNombreNegocio());
            
            return ResponseEntity.ok(config);
        } catch (Exception e) {
            System.err.println("‚ùå Error al obtener configuraci√≥n: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR)
                    .body(createErrorResponse("Error al obtener configuraci√≥n: " + e.getMessage()));
        }
    }

    /**
     * POST /api/configuracion - Crear o actualizar configuraci√≥n
     */
    @PostMapping
    public ResponseEntity<?> guardarConfiguracion(
            @RequestBody ConfiguracionNegocio configuracion,
            Authentication authentication) {
        try {
            if (authentication == null || authentication.getName() == null) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED)
                        .body(createErrorResponse("Usuario no autenticado"));
            }

            String email = authentication.getName();
            System.out.println("üíæ Guardando configuraci√≥n para: " + email);
            System.out.println("üì§ Datos recibidos: " + configuracion.getNombreNegocio());
            
            ConfiguracionNegocio configGuardada = configuracionService.guardarConfiguracion(email, configuracion);
            System.out.println("‚úÖ Configuraci√≥n guardada exitosamente");
            
            return ResponseEntity.ok(configGuardada);
        } catch (Exception e) {
            System.err.println("‚ùå Error al guardar configuraci√≥n: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR)
                    .body(createErrorResponse("Error al guardar configuraci√≥n: " + e.getMessage()));
        }
    }

    /**
     * PUT /api/configuracion - Actualizar configuraci√≥n
     */
    @PutMapping
    public ResponseEntity<?> actualizarConfiguracion(
            @RequestBody ConfiguracionNegocio configuracion,
            Authentication authentication) {
        try {
            if (authentication == null || authentication.getName() == null) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED)
                        .body(createErrorResponse("Usuario no autenticado"));
            }

            String email = authentication.getName();
            System.out.println("üîÑ Actualizando configuraci√≥n para: " + email);
            
            ConfiguracionNegocio configActualizada = configuracionService.guardarConfiguracion(email, configuracion);
            System.out.println("‚úÖ Configuraci√≥n actualizada exitosamente");
            
            return ResponseEntity.ok(configActualizada);
        } catch (Exception e) {
            System.err.println("‚ùå Error al actualizar configuraci√≥n: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR)
                    .body(createErrorResponse("Error al actualizar configuraci√≥n: " + e.getMessage()));
        }
    }

    /**
     * M√©todo auxiliar para crear respuestas de error consistentes
     */
    private Map<String, String> createErrorResponse(String mensaje) {
        Map<String, String> error = new HashMap<>();
        error.put("error", mensaje);
        return error;
    }
}